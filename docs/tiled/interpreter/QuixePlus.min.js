!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).QuixePlus=e()}(this,(function(){"use strict";function t(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function e(t){return t.replace(/^I[^_]*_/,"")}function r(t){return t.replace(/^K[^_]*_/,"")}if(!window.Quixe)throw new Error("Missing global Quixe");const s=window.Quixe.get_vm_internals();if(!s.getConstantString)throw new Error("Missing Quixe modification getConstantString()");const a={read1:t=>s.Mem1(t),read2:t=>s.Mem2(t),read4:t=>s.Mem4(t),getConstantString:t=>s.getConstantString(t),getType(t){return this.read1(t)},getObjectAttribute(t,e){if(112!==this.getType(t))return null;return!!(this.read1(t+1+(e>>3))&1<<(7&e))},getObjectNext(t){return 112!==this.getType(t)?null:this.read4(t+8)},getObjectHarwardName(t){if(112!==this.getType(t))return null;const e=this.read4(t+12);return this.getConstantString(e)},getObjectProperty(t,e){if(112!==this.getType(t))return null;const r=this.read4(t+16),s=this.read4(r+0);for(let t=0;t<s;t++){const s=r+4+10*t;if(this.read2(s+0)==e){const t=this.read4(s+4);return this.read4(t)}}return null},getObjectParent(t){return 112!==this.getType(t)?null:this.read4(t+20)},getObjectSibling(t){return 112!==this.getType(t)?null:this.read4(t+24)},getObjectFirstChild(t){return 112!==this.getType(t)?null:this.read4(t+28)}};let n=new class{constructor(){t(this,"objectsByValue",{}),t(this,"classesByValue",{}),t(this,"arraysByValue",{}),t(this,"propertyIDsByValue",{}),t(this,"objectIDsByName",{}),t(this,"classIDsByName",{}),t(this,"attributeIDsByName",{}),t(this,"propertyIDsByName",{})}init(t){Object.assign(this,t),Object.keys(this.objectsByID).forEach(t=>{const e=this.getObjectValueByID(t);this.objectsByValue[e]=t}),Object.keys(this.classesByID).forEach(t=>{const e=this.getClassValueByID(t);this.classesByValue[e]=t}),Object.keys(this.arraysByID).forEach(t=>{const e=this.getArrayByID(t),r=e[0];this.arraysByValue[r]=e}),Object.keys(this.objectsByID).forEach(t=>{this.objectIDsByName[e(t)]=t}),Object.keys(this.classesByID).forEach(t=>{this.classIDsByName[r(t)]=t}),Object.keys(this.attributesByID).forEach(t=>{this.attributeIDsByName[function(t){return t.replace(/^p[0-9]+_/,"")}(t)]=t}),Object.keys(this.propertiesByID).forEach(t=>{this.propertyIDsByName[function(t){return t.replace(/^p[0-9]+_/,"")}(t)]=t,this.propertyIDsByValue[this.propertiesByID[t]]=t})}getType(t){return this.objectsByValue[t]?"object":this.arraysByValue[t]?"array":this.classesByValue[t]?"class":"unknown"}getGlobalValueByID(t){const e=this.globalsByID[t];return a.read4(e)}getObjectValueByID(t){return this.objectsByID[t]}getObjectIDByValue(t){return this.objectsByValue[t]}getObjectIDByName(t){return this.objectIDsByName[t]}getClassValueByID(t){return this.classesByID[t]}getClassIDByValue(t){return this.classesByValue[t]}getClassIDByName(t){return this.classIDsByName[t]}getArrayByID(t){return this.arraysByID[t]}getArrayByValue(t){return this.arraysByValue[t]}getPropertyValueByID(t){return this.propertiesByID[t]}getPropertyIDByName(t){return this.propertyIDsByName[t]}getAttributeValueByID(t){return this.attributesByID[t]}getAttributeIDByName(t){return this.attributeIDsByName[t]}};window.gameinfo&&n.init(window.gameinfo);class i{static create(t){return new i(t)}constructor(e){t(this,"value",0),this.value=e}asArray(){return o.create(this.value)}asString(){return l.create(this.value)}asObject(){return c.create(this.value)}getValue(){return this.value}}class o extends i{static create(t,e=o){let r;return null==t&&(r=null),r="string"==typeof t?n.getArrayByID(t):n.getArrayByValue(t),r?new e(r):null}constructor([t,e,r,s]){const a=t;if(1!==r&&4!==r)throw new Error("Unsupported array: "+JSON.stringify({address:a,byteCount:e,bytesPerElement:r,zerothHasLength:s}));super(t),this.address=a,this.byteCount=e,this.bytesPerElement=r,this.length=e/r,this.zerothHasLength=s}atRaw(t){return t<0||t>this.length?null:1===this.bytesPerElement?a.read1(this.address+t):4===this.bytesPerElement?a.read4(this.address+4*t):void 0}at(t,e){const r=this.atRaw(t);return e===String?l.create(r).toString():e&&e.create?e.create(r):e?new e(r):r}toJSArray(){const t=[];for(let e=0;e<this.length;e++)t.push(this.atRaw(e));return t}}class l extends o{static create(t){return o.create(t,l)}toString(){const t=this.atRaw(1);return a.getConstantString(t)}}class c extends i{static mergeAttrMap(t){Object.assign(c.attrMap,t)}static create(t){let e,r;return null==t&&(e="nothing"),"string"==typeof t?e=t:r=t,e=e||n.getObjectIDByValue(r),r=r||n.getObjectValueByID(e),null==e||null==r?c.create("nothing"):new c(e,r)}constructor(r,s){if(null==r||null==s)throw new Error("Incorrect object creation");super(s),t(this,"id",""),t(this,"name",""),this.id=r,this.name=e(this.id)}get kind(){return this.getProperty("inheritance class",u)}get kinds(){const t=o.create("KindHierarchy").toJSArray(),e={};t.forEach((r,s)=>{if(s%2==0){const a=t[2*t[s+1]];e[r]=a}});const r=[];let s,a=this.getProperty("inheritance class");for(;a!==s;)r.push(a),s=a,a=e[a];return r.map(t=>u.create(t))}get children(){const t=[];let e=a.getObjectFirstChild(this.value);if(e){let r=e;for(;r;)t.push(c.create(r)),r=a.getObjectSibling(r)}return t}get parent(){const t=a.getObjectParent(this.value);return t?c.create(t):null}getProperty(t,e){const r=n.getPropertyIDByName(t);if(!r)return null;const s=a.getObjectProperty(this.value,n.getPropertyValueByID(r));return e===String?l.create(s).toString():e&&e.create?e.create(s):e?new e(s):s}printAllProperties(){const t=a.read4(this.value+16),e=a.read4(t+0);for(let r=0;r<e;r++){const e=t+4+10*r,s=a.read2(e+0),i=a.read4(e+4),o=a.read4(i),l=n.propertyIDsByValue[s];console.log(s,l,o,e)}}printAllAttributes(){Object.keys(n.attributesByID).forEach(t=>{const e=n.getAttributeValueByID(t),r=Boolean(a.getObjectAttribute(this.value,e)),s=1+(e>>3),i=7&e;console.log(t,r,s,i)})}getAttribute(t){const e=n.getAttributeIDByName(t);return e?Boolean(a.getObjectAttribute(this.value,n.getAttributeValueByID(e))):null}is(t){let e=!1;"!"===t.charAt(0)&&(e=!e,t=t.slice(1)),"!"===(t=c.attrMap[t]||t).charAt(0)&&(e=!e,t=t.slice(1));const r=this.getAttribute(t);return e?!r:r}traverse(t){!function e(r){t(r);for(let t of r.children)e(t)}(this)}}t(c,"attrMap",{person:"animate",clothing:"wearable",undescribed:"concealed",inedible:"!edible",dark:"!light",unlockable:"!lockable",unlocked:"!locked",handled:"moved",off:"!on",closed:"!open","fixed in place":"static",portable:"!static",device:"switchable",opaque:"!transparent",room:"mark_as_room",thing:"mark_as_thing",lit:"light"});class u extends c{static create(t){if(null==t)throw new Error("Invalid InformClass");let e,r;if("string"==typeof t?e=t:r=t,e=e||n.getClassIDByValue(r),r=r||n.getClassValueByID(e),null==e||null==r)throw new Error("Invalid InformClass");return new u(e,r)}constructor(t,e){if(null==t||null==e)throw new Error("Incorrect class creation");super(t,e),this.name=r(this.id)}}var h=Object.freeze({__proto__:null,InformValue:i,InformArray:o,InformString:l,InformObject:c,InformClass:u});function y(t){return d(t)[0]||null}const g=[/nothing/,/Compass/,/thedark/,/InformParser/,/InformLibrary/,/property_numberspace_forcer/,/ValuePropertyHolder_[\d]+/,/selfobj/];function p(t){return!g.some(e=>e.test(t))}function d(t){let e=[];if("string"!=typeof t)throw new Error("query must be a string");try{if("**"===t)e=Object.keys(n.objectsByID).map(t=>c.create(t));else if("*"===t)e=Object.keys(n.objectsByID).filter(p).map(t=>c.create(t)).filter(t=>!(t.parent&&"Compass"===t.parent.id));else{const r=t.charAt(0),s=t.slice(1);if("."===r){const t=s.split(",");e=d("*").filter(e=>t.every(t=>e.is(t)))}else{const r=n.getObjectIDByName(t);r&&e.push(c.create(r));const s=n.getClassIDByName(t);s&&e.push(u.create(s));const a=o.create(t);a&&e.push(a);const l=n.getGlobalValueByID(t);l&&e.push(i.create(l))}}}catch(t){e=[]}return e}class b extends c{constructor(){const t=n.getGlobalValueByID("player");super(n.getObjectIDByValue(t),t)}get location(){return c.create(n.getGlobalValueByID("real_location"))}get inventory(){return this.children}has(t){let e=!1;return this.traverse(r=>{r.name===t&&(e=!0)}),e}}const f=[];window.game_options&&(window.game_options.before_select_hook=function(){f.forEach(t=>t.handleNewTurn())});function B(t){return y(t)}return Object.assign(B,h,{version:"0.0.1",all:d,mergeAttrMap:c.mergeAttrMap,Updater:class{constructor(e){t(this,"player",new b),this.spec=e,f.push(this),this.update()}handleNewTurn(){this.update()}update(){const t={player:this.player,location:this.player.location};Object.keys(this.spec).forEach(e=>{d(e).forEach(r=>this.spec[e](r,t))})}},Player:b,SVGMap:class{constructor(e){t(this,"url","./map.svg"),t(this,"containerSelector","#quixeplus-pane"),t(this,"debug",!1),t(this,"onReady",()=>{}),Object.assign(this,e),this.log("map options",e),this.ready=this.initAsync()}log(...t){this.debug&&console.log(...t)}async initAsync(){const[t]=await Promise.all([this.load(this.url),new Promise($)]);this.$container=$(this.containerSelector),this.$container.html(t),this.$svg=this.$container.find("svg"),this.log("Map ready."),this.onReady()}async load(t){const e=await fetch(t);return await e.text()}$get(t,e){let r;r=e?`[data-${t}="${e}"]`:`[data-${t}]`;const s=this.$svg.find(r);return 0===s.length&&this.log(`$get(${t}, ${e}) returned nothing. Check the data-* attributes in you SVG.`),s}},internals:{gameinfo:n,VM:a}}),window.QQ=d,window.Q=y,B}));
