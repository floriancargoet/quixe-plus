!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).QuixePlus=e()}(this,function(){"use strict";function t(t){return t.replace(/^I[^_]*_/,"")}function e(t){return t.replace(/^K[^_]*_/,"")}if(!globalThis.Quixe)throw new Error("Missing global Quixe");const r=globalThis.Quixe.get_vm_internals();if(!r.getConstantString)throw new Error("Missing Quixe modification getConstantString()");const s=112,a={read1:t=>r.Mem1(t),read2:t=>r.Mem2(t),read4:t=>r.Mem4(t),getConstantString:t=>r.getConstantString(t),getType(t){return this.read1(t)},getObjectAttribute(t,e){if(this.getType(t)!==s)return null;return!!(this.read1(t+1+(e>>3))&1<<(7&e))},getObjectNext(t){return this.getType(t)!==s?null:this.read4(t+8)},getObjectHarwardName(t){if(this.getType(t)!==s)return null;const e=this.read4(t+12);return this.getConstantString(e)},getObjectProperty(t,e){if(this.getType(t)!==s)return null;const r=this.read4(t+16),a=this.read4(r+0);for(let t=0;t<a;t++){const s=r+4+10*t;if(this.read2(s+0)==e){const t=this.read4(s+4);return this.read4(t)}}return null},getObjectParent(t){return this.getType(t)!==s?null:this.read4(t+20)},getObjectSibling(t){return this.getType(t)!==s?null:this.read4(t+24)},getObjectFirstChild(t){return this.getType(t)!==s?null:this.read4(t+28)}};let n=new class{objectsByValue={};classesByValue={};arraysByValue={};propertyIDsByValue={};objectIDsByName={};classIDsByName={};attributeIDsByName={};propertyIDsByName={};init(r){Object.assign(this,r),Object.keys(this.objectsByID).forEach(t=>{const e=this.getObjectValueByID(t);this.objectsByValue[e]=t}),Object.keys(this.classesByID).forEach(t=>{const e=this.getClassValueByID(t);this.classesByValue[e]=t}),Object.keys(this.arraysByID).forEach(t=>{const e=this.getArrayByID(t),r=e[0];this.arraysByValue[r]=e}),Object.keys(this.objectsByID).forEach(e=>{this.objectIDsByName[t(e)]=e}),Object.keys(this.classesByID).forEach(t=>{this.classIDsByName[e(t)]=t}),Object.keys(this.attributesByID).forEach(t=>{this.attributeIDsByName[function(t){return t.replace(/^p[0-9]+_/,"")}(t)]=t}),Object.keys(this.propertiesByID).forEach(t=>{this.propertyIDsByName[function(t){return t.replace(/^p[0-9]+_/,"")}(t)]=t,this.propertyIDsByValue[this.propertiesByID[t]]=t})}getType(t){return this.objectsByValue[t]?"object":this.arraysByValue[t]?"array":this.classesByValue[t]?"class":"unknown"}getGlobalValueByID(t){const e=this.globalsByID[t];return a.read4(e)}getObjectValueByID(t){return this.objectsByID[t]}getObjectIDByValue(t){return this.objectsByValue[t]}getObjectIDByName(t){return this.objectIDsByName[t]}getClassValueByID(t){return this.classesByID[t]}getClassIDByValue(t){return this.classesByValue[t]}getClassIDByName(t){return this.classIDsByName[t]}getArrayByID(t){return this.arraysByID[t]}getArrayByValue(t){return this.arraysByValue[t]}getPropertyValueByID(t){return this.propertiesByID[t]}getPropertyIDByName(t){return this.propertyIDsByName[t]}getAttributeValueByID(t){return this.attributesByID[t]}getAttributeIDByName(t){return this.attributeIDsByName[t]}};globalThis.gameinfo&&n.init(globalThis.gameinfo);class i{value=0;static create(t){return new i(t)}constructor(t){this.value=t}asArray(){return l.create(this.value)}asString(){return o.create(this.value)}asObject(){return c.create(this.value)}getValue(){return this.value}}class l extends i{static create(t,e=l){let r;return null==t&&(r=null),r="string"==typeof t?n.getArrayByID(t):n.getArrayByValue(t),r?new e(r):null}constructor([t,e,r,s]){const a=t;if(1!==r&&4!==r)throw new Error("Unsupported array: "+JSON.stringify({address:a,byteCount:e,bytesPerElement:r,zerothHasLength:s}));super(t),this.address=a,this.byteCount=e,this.bytesPerElement=r,this.length=e/r,this.zerothHasLength=s}atRaw(t){return t<0||t>this.length?null:1===this.bytesPerElement?a.read1(this.address+t):4===this.bytesPerElement?a.read4(this.address+4*t):void 0}at(t,e){const r=this.atRaw(t);return e===String?o.create(r).toString():e&&e.create?e.create(r):e?new e(r):r}toJSArray(){const t=[];for(let e=0;e<this.length;e++)t.push(this.atRaw(e));return t}}class o extends l{static create(t){return l.create(t,o)}toString(){const t=this.atRaw(1);return a.getConstantString(t)}}class c extends i{id="";name="";static attrMap={person:"animate",clothing:"wearable",undescribed:"concealed",inedible:"!edible",dark:"!light",unlockable:"!lockable",unlocked:"!locked",handled:"moved",off:"!on",closed:"!open","fixed in place":"static",portable:"!static",device:"switchable",opaque:"!transparent",room:"mark_as_room",thing:"mark_as_thing",lit:"light"};static mergeAttrMap(t){Object.assign(c.attrMap,t)}static create(t){let e,r;return null==t&&(e="nothing"),"string"==typeof t?e=t:r=t,e=e||n.getObjectIDByValue(r),r=r||n.getObjectValueByID(e),null==e||null==r?c.create("nothing"):new c(e,r)}constructor(e,r){if(null==e||null==r)throw new Error("Incorrect object creation");super(r),this.id=e,this.name=t(this.id)}get kind(){return this.getProperty("inheritance class",u)}get kinds(){const t=l.create("KindHierarchy").toJSArray(),e={};t.forEach((r,s)=>{if(s%2==0){const a=t[2*t[s+1]];e[r]=a}});const r=[];let s,a=this.getProperty("inheritance class");for(;a!==s;)r.push(a),s=a,a=e[a];return r.map(t=>u.create(t))}get children(){const t=[];let e=a.getObjectFirstChild(this.value);if(e){let r=e;for(;r;)t.push(c.create(r)),r=a.getObjectSibling(r)}return t}get parent(){const t=a.getObjectParent(this.value);return t?c.create(t):null}getProperty(t,e){const r=n.getPropertyIDByName(t);if(!r)return null;const s=a.getObjectProperty(this.value,n.getPropertyValueByID(r));return e===String?o.create(s).toString():e&&e.create?e.create(s):e?new e(s):s}printAllProperties(){const t=a.read4(this.value+16),e=a.read4(t+0);for(let r=0;r<e;r++){const e=t+4+10*r,s=a.read2(e+0),i=a.read4(e+4),l=a.read4(i),o=n.propertyIDsByValue[s];console.log(s,o,l,e)}}printAllAttributes(){Object.keys(n.attributesByID).forEach(t=>{const e=n.getAttributeValueByID(t),r=Boolean(a.getObjectAttribute(this.value,e)),s=1+(e>>3),i=7&e;console.log(t,r,s,i)})}getAttribute(t){const e=n.getAttributeIDByName(t);return e?Boolean(a.getObjectAttribute(this.value,n.getAttributeValueByID(e))):null}is(t){let e=!1;"!"===t.charAt(0)&&(e=!e,t=t.slice(1)),"!"===(t=c.attrMap[t]||t).charAt(0)&&(e=!e,t=t.slice(1));const r=this.getAttribute(t);return e?!r:r}traverse(t){!function e(r){t(r);for(let t of r.children)e(t)}(this)}}class u extends c{static create(t){if(null==t)throw new Error("Invalid InformClass");let e,r;if("string"==typeof t?e=t:r=t,e=e||n.getClassIDByValue(r),r=r||n.getClassValueByID(e),null==e||null==r)throw new Error("Invalid InformClass");return new u(e,r)}constructor(t,r){if(null==t||null==r)throw new Error("Incorrect class creation");super(t,r),this.name=e(this.id)}}const h=Object.freeze(Object.defineProperty({__proto__:null,InformArray:l,InformClass:u,InformObject:c,InformString:o,InformValue:i},Symbol.toStringTag,{value:"Module"}));function y(t){return b(t)[0]||null}const g=[/nothing/,/Compass/,/thedark/,/InformParser/,/InformLibrary/,/property_numberspace_forcer/,/ValuePropertyHolder_[\d]+/,/selfobj/];function p(t){return!g.some(e=>e.test(t))}function b(t){let e=[];if("string"!=typeof t)throw new Error("query must be a string");try{if("**"===t)e=Object.keys(n.objectsByID).map(t=>c.create(t));else if("*"===t)e=Object.keys(n.objectsByID).filter(p).map(t=>c.create(t)).filter(t=>!(t.parent&&"Compass"===t.parent.id));else{const r=t.charAt(0),s=t.slice(1);if("."===r){const t=s.split(",");e=b("*").filter(e=>t.every(t=>e.is(t)))}else{const r=n.getObjectIDByName(t);r&&e.push(c.create(r));const s=n.getClassIDByName(t);s&&e.push(u.create(s));const a=l.create(t);a&&e.push(a);const o=n.getGlobalValueByID(t);o&&e.push(i.create(o))}}}catch(t){e=[]}return e}class d extends c{constructor(){const t=n.getGlobalValueByID("player");super(n.getObjectIDByValue(t),t)}get location(){return c.create(n.getGlobalValueByID("real_location"))}get inventory(){return this.children}has(t){let e=!1;return this.traverse(r=>{r.name===t&&(e=!0)}),e}}const f=[];globalThis.game_options&&(globalThis.game_options.before_select_hook=function(){f.forEach(t=>t.handleNewTurn())});function B(t){return y(t)}return Object.assign(B,h,{version:"0.0.1",all:b,mergeAttrMap:c.mergeAttrMap,Updater:class{player=new d;constructor(t){this.spec=t,f.push(this),this.update()}handleNewTurn(){this.update()}update(){const t={player:this.player,location:this.player.location};Object.keys(this.spec).forEach(e=>{b(e).forEach(r=>this.spec[e](r,t))})}},Player:d,SVGMap:class{url="./map.svg";containerSelector="#quixeplus-pane";debug=!1;onReady=()=>{};constructor(t){Object.assign(this,t),this.log("map options",t),this.ready=this.initAsync()}log(...t){this.debug&&console.log(...t)}async initAsync(){const[t]=await Promise.all([this.load(this.url),new Promise($)]);this.$container=$(this.containerSelector),this.$container.html(t),this.$svg=this.$container.find("svg"),this.log("Map ready."),this.onReady()}async load(t){const e=await fetch(t);return await e.text()}$get(t,e){let r;r=e?`[data-${t}="${e}"]`:`[data-${t}]`;const s=this.$svg.find(r);return 0===s.length&&this.log(`$get(${t}, ${e}) returned nothing. Check the data-* attributes in you SVG.`),s}},internals:{gameinfo:n,VM:a}}),globalThis.QQ=b,globalThis.Q=y,B});
